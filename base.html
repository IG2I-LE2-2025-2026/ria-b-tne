<script type="text/javascript" src="jquery-3.7.0.min.js"></script>
<script type="text/javascript" src="api-root.js"></script>

<style>
	#identification {display:none;}
	.hidden {display:none;}
	.red {color:red;}
</style>

<script>
 
	var cache = {
		"apiRoot" : false,
		"hash" : false, 
		"pseudo" : false
	}; 
	
	function autologin(numAPI) {
		if(numAPI == undefined) numAPI = 0; 
		cache.apiRoot = roots[numAPI].root; 
		cache.pseudo = roots[numAPI].pseudo; 
		cache.hash = roots[numAPI].hash; 
		$("#serveur select option:eq(" + numAPI+1 + ")").prop("selected","selected");
		$("#pseudo").html("Pseudo : " + cache.pseudo).show();	
		 chargerArticles();		 
	}
	
	$(document).ready(function(){
	
		// reaction au changement dans le menu déroulant des articles
		// IL DOIT EXISTER !! 
		// LE DOCUMENT DOIT ETRE CHARGE  
		$("select","#articles").change(function(){
			// quelle est l'option sélectionnée ? 
			// $(this) c'est le select des articles 
			// console.log($("option:selected",$(this)));
			// quelles sont ses données ? 
			console.log($("option:selected",$(this)).data());
			// var id = $("option:selected",$(this)).data("id"); 
			// chargerArticle($("option:selected",$(this)).data()); 
		}); // fin change select articles
				
		
		// click sur btn OK pour s'identifier
		$("#identification input[value='OK']").click(function(){
				console.log("OK identification");
				//var user = $("#identification input[type='text']").val(); 
				//var password = $("#identification input[type='password']").val();
				var user = $("input[type='text']", $(this).parent()).val();
				var password = $("input[type='password']", $(this).parent()).val();
				console.log("user: "+user+" pass:"+password);
				
				$.ajax({
					type: "POST",
					url: cache.apiRoot + "/authenticate",
					//headers: {"debug-data":true},
					data: {"user":user,"password":password},
					dataType: "json",
					success: function(oRep){

						console.log(oRep); 
						$("#msg").hide();
						cache.hash = oRep.hash;
						cache.pseudo = user; 
						$("#pseudo").html("Pseudo : " + cache.pseudo).show();						
						$("#identification").hide(); 
						chargerArticles();  
					},
					error: function(){
						$("#msg").html("Erreur d'identification !").show();
					},	
				}); // fin ajax POST authenticate
				
		}); // fin click OK #identification
		
		// reaction au changement dans le menu déroulant des api 
		$("select","#serveur").change(function(){
			// $(this) denote le select 
			cache.apiRoot = $("option:selected", $(this)).html(); 
			console.log("API root : " + cache.apiRoot);	
			$("#identification").show("slow");
			$("#articles").hide(); 
			cache.pseudo = false; 
			$("#pseudo").html("").hide();	
			
		}); // fin change select root
		
		// remplissage du select des api 
		for(i=0;i<roots.length;i++) {
			$("select","#serveur").append(
				// "<option>" + roots[i].root + "</option>"
				$("<option>")
					.html(roots[i].root)
			);
		} // fin remplissage du select des api 
		

		
		autologin();
	}); // fin doc.ready
	
	function chargerArticles() {
		
		// GET /articles 
		$.getJSON(cache.apiRoot + "/articles", 
			{hash:cache.hash}, 
			function(oRep){
				console.log(oRep);
				
				// vide le menu déroulant des articles 
				$("select", "#articles").empty(); 
				
				// rajouter la première option 
				// <option selected disabled>Choisir l'article à éditer</option>
				$("select", "#articles").append(
						$("<option>")
							.html("Choisir l'article &agrave; &eacute;diter")
							.attr("selected","selected")
							.attr("disabled","disabled")						
				); 
								
				// remplir le select des articles 
				var i; // locale !! 
				for(i=0;i<oRep.articles.length;i++) {
					$("select", "#articles").append(
						$("<option>")
							.html(oRep.articles[i].titre)
							.data(oRep.articles[i])
					); 
				}
				
				// afficher 
				$("#articles").show();
				
		
		}); // fin get /articles 
		
		// remplir le menu déroulant dans #articles 
		// Attention à bien écraser les données précédentes ! 
		// penser à le vide d'abord avant de le remplir 
		// afficher #articles 
	
	} 
</script>

<body>

	<fieldset id="serveur">
		<legend>Serveur</legend>
		<select>
			<option selected disabled>Choisir la racine de l'API</option>
		</select>
		<div class="hidden" id="pseudo"></div>
	</fieldset>
	
	<fieldset class="hidden" id="identification">
		<legend>Identification</legend>
		Pseudo : <input type="text" value=""/> <br />
		Password : <input type="password" value="" /> <br />
		<input type="button" value="OK"/>
		<div class="hidden red" id="msg"></div>
	</fieldset>
	
	<fieldset class="hidden" id="articles">
		<legend>Articles</legend>
		<select>
			<option selected disabled>Choisir l'article à éditer</option>
		</select>
		<div class="hidden red" id="article"></div>
	</fieldset>
</body>

	

