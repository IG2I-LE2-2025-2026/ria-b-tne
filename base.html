<script type="text/javascript" src="jquery-3.7.0.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script type="text/javascript" src="api-root.js"></script>

<link href="jquery-ui.min.css" rel="stylesheet">
<style>
	#contenu div {
		position:relative; 
	}
	
	.corbeille, .poignee {
		position:absolute;
	}
	
	.poignee {
		top:5px;left:0px;
	}
	
	.poignee:hover{
		cursor:grabbing;
	}
	
	.corbeille:hover{
		cursor:pointer;
	}
	
	.corbeille {
		top:-2px;right:0;
	}
	
	#contenu div p:hover {
		cursor:pointer;
	}

	#contenu div p {
		margin-left:20px;
		margin-right:20px;
		padding:0 4px;
	}
	
	.allume {
		background-color:yellow;
		border:1px solid black;
		height:5px;
	}
	
	#identification {display:none;}
	.hidden {display:none;}
	.red {color:red;}
	
	#contenu {
		border:1px solid black;
		padding:5px;
	}

	#contenu div {
		position:relative;
		height:30px;
		margin:5px 0;
	}

	#contenu textarea{
		display:block;
		position:absolute;
		left:0;right:0;
		margin-left:20px;
		margin-right:20px;
		padding:0 4px;
		
	}

	.desactive{
		font-style:italic;
		color:lightgrey;
	}

	#contenu p:not(.desactive):hover{
		cursor:pointer;
		border:1px dashed black;
	}

	#contenu p.desactive:hover{
		cursor:not-allowed;
	}

	.m5 {
		margin:5px 0;
	}
</style>

<script>
 
	var cache = {
		"apiRoot" : false,
		"hash" : false, 
		"pseudo" : false
	}; 
	
	function autologin(numAPI) {
		if(numAPI == undefined) numAPI = 0; 
		cache.apiRoot = roots[numAPI].root; 
		cache.pseudo = roots[numAPI].pseudo; 
		cache.hash = roots[numAPI].hash; 
		$("#serveur select option:eq(" + numAPI+1 + ")").prop("selected","selected");
		$("#pseudo").html("Pseudo : " + cache.pseudo).show();	
		$("input[value='Logout']", "#serveur").show();
		

		chargerArticles(3361); 
		// 1) req AJAX pour récupérer tous les articles 
		// Son exécution est ASYNCHRONE !!!!! 
		// La fonction se termine immédiatement 
		// AVANT que le serveur ait répondu !!!
		 
		// 3) récupération de la réponse du serveur 
		// pour les afficher 
		// sélectionner le 3361
		  
		// $("select","#articles").change();
		// 2) on déclenche change TROP TOT  
		// "fait comme si on venait de changer"
		// pour déclencher l'affichage de ses paragraphes  
		
	}
	
// afficher les méta-données s'il y en a 
$(document).on("mouseover","#contenu *", function(){
	var meta = $(this).data(); 
	if (! $.isEmptyObject(meta)) console.log(meta); 
}); 


// Lors de l'appui sur Escape 
// dans le document 
// parcourir les TA
// les remplacer par des P. en reprenant leur contenu initial 
$(document).keyup(function(contexte){
	if (contexte.key=="Escape") {
		$("#contenu textarea").each(function(){	
			var jPClone = jPEditable
				.clone(true)
				.data($(this).data())
				.html($(this).data("contenu")); 
				
			$(this).replaceWith(jPClone);
		}); 
	}
}); // fin Esc. 


	// click sur corbeille : afficher le contenu du P ? 
	$(document).on("click",".corbeille", function(){
		// les méta-données sont dans le p ou le textarea
		// il faudrait les intégrer dans le div parent du groupe p/span/span 
		// mais ça ferait bcp de travail 
		var jDiv = $(this).parent(); 
		var meta = $("p,textarea",jDiv).data();
		console.log(meta);
		
		var idArticle = $(this).parents("fieldset").data("id");
		
		$.ajax({
			type: "DELETE",
			url: cache.apiRoot 
					+ "/articles/" + idArticle 
					+ "/paragraphes/" + meta.id,		
			headers: {"hash":cache.hash},
			success: function(oRep){
				jDiv.remove();
			},
			dataType: "json"
		});
			 
	}); 
	
	$(document).ready(function(){
	
		$( "#contenu" ).sortable({
				handle:".poignee",
				placeholder: "allume", 
				stop: function(contexte,ui){
					
					// objet ui contient item : une référence vers l'élément déplacé 
					// console.log("avant:" + ui.item.prev().html()); 
					// console.log("avant:" + $("p",ui.item.prev()).html()); 
					// $(selecteur,contexte)				
					// console.log("apres:" + ui.item.next().text()); 
					
					var avant = ui.item.prev(); 
					var apres = ui.item.next(); 
					if (avant.length != 0) {
						var meta = $("p,textarea",avant).data(); 
						var ordre = parseInt(meta.ordre)+1; 
					}
					else {
						var meta = $("p,textarea",apres).data();
						var ordre = meta.ordre; 
					}
					
					console.log(meta);
					var idArticle = $(this).parents("fieldset").data("id");
		
					$.ajax({
						type: "PUT",
						url: cache.apiRoot 
								+ "/articles/" + idArticle 
								+ "/paragraphes/" + $("p,textarea",ui.item).data("id")
								+ "?ordre=" + ordre,		
						headers: {"hash":cache.hash},
						success: function(oRep){
							// TODO : mettre à jour les méta-données 
							// ATTENTION ! tous les ordres des P. peuvent avoir changé !! 
							// soit on met à jour à la main dans les données les ordres des P., comme ce qui est fait côté API
							// soit on relit tous les P. depuis l'API et on propage les ordres 
							// soit on recrée tous les P. en les relisant depuis l'API => pas très efficace... 
							// On choisit la deuxième solution à titre pédagogique 
							
							$.getJSON(cache.apiRoot + "/articles/" + idArticle + "/paragraphes", 
								{hash:cache.hash}, 
								function(oRep){
									console.log(oRep);
									var i; 
									
									// Hypothèse : les P. sont dans le bon ordre côté client 
									// On ne fait que propager leurs numéros d'ordre
									for(i=0;i<oRep.paragraphes.length;i++) {
										// pour chaque meta de P, il faut retrouver le P. côté client
										var currentMetaP =  oRep.paragraphes[i]; 
										$("#contenu > div > p,textarea").each (function(){
											console.log("cur:" + $(this).html()); 
											if ($(this).data("id") == currentMetaP.id) {
												$(this).data("ordre", currentMetaP.ordre); 
											}										
										}); 
									}		
									
								}); 
								
							},// fin success 
							dataType: "json"
						});
			
			
				}
			}
		);
	
		// click logout
		$("input[value='Logout']", "#serveur").click(function(){
			cache.hash = ""; 
			cache.pseudo = false;  
			$("#identification").show();
			$("#articles").hide("slow"); 
			$("#article").hide("slow");
			$("input[value='Logout']", "#serveur").hide(); 
			$("#pseudo").html("").hide();
		});
	
		// insérer btn + avant et après le contenu
		$("#contenu").before(jAjoutP.clone(true));
		$("#contenu").after(jAjoutP.clone(true));
		
		$("#articles select").after(jAddDelA); 
		
	
		// reaction au changement dans le menu déroulant des articles
		// IL DOIT EXISTER !! 
		// LE DOCUMENT DOIT ETRE CHARGE  
		$("select","#articles").change(function(){
			// quelle est l'option sélectionnée ? 
			// $(this) c'est le select des articles 
			// console.log($("option:selected",$(this)));
			// quelles sont ses données ?
			console.log("change"); 
			
			var meta = $("option:selected",$(this)).data();
			if ($.isEmptyObject(meta)) return ; 
			var id = meta.id; 
			console.log("id vaut " + id); 
			chargerArticle($("option:selected",$(this)).data()); 
		}); // fin change select articles
				
		
		// click sur btn OK pour s'identifier
		$("#identification input[value='OK']").click(function(){
				console.log("OK identification");
				//var user = $("#identification input[type='text']").val(); 
				//var password = $("#identification input[type='password']").val();
				
				// $(this) est le bouton OK
				// $(this).parent() est le fieldset #identification
				// $("input[type='text']", $(this).parent())
				// le seul champ texte de ce fieldset 
				// Possible aussi : 
				// $("#identification input[type='text']")
				
				var user = $("input[type='text']", $(this).parent()).val();
				var password = $("input[type='password']", $(this).parent()).val();
				console.log("user: "+user+" pass:"+password);
				
				$.ajax({
					type: "POST",
					url: cache.apiRoot + "/authenticate",
					//headers: {"hash":hash},
					data: {"user":user,"password":password},
					dataType: "json", // nature du résultat attendu
					success: function(oRep){

						console.log(oRep); 
						$("#msg").hide();
						cache.hash = oRep.hash;
						cache.pseudo = user; 
						$("#pseudo").html("Pseudo : " + cache.pseudo).show();
						$("input[value='Logout']", "#serveur").show();
						$("#identification").hide(); 
						chargerArticles();  
					},
					error: function(){
						$("#msg").html("Erreur d'identification !").show();
					},	
				}); // fin ajax POST authenticate
				
		}); // fin click OK #identification
		
		// reaction au changement dans le menu déroulant des api 
		$("select","#serveur").change(function(){
			// $(this) denote le select 
			
			//$(selecteur,contexte) : rechercher le selecteur 
			// SOUS le contexte passé en paramètre
			// contexte peut être : une référence jQuery
			// un sélecteur CSS 
			
			// $("option:selected", $(this))
			// $("option:selected", "#serveur")
			// $("option:selected", "#serveur select")
			// $("#serveur option:selected")
			
			cache.apiRoot = $("option:selected", $(this)).html(); 
			console.log("API root : " + cache.apiRoot);	
			$("#identification").show("slow");
			$("#articles").hide(); 
			cache.pseudo = false; 
			$("#pseudo").html("").hide();
			$("#articles").hide("slow");
			$("#article").hide("slow");
			
		}); // fin change select root
		
		// remplissage du select des api 
		for(i=0;i<roots.length;i++) {
			$("select","#serveur").append(
				// "<option>" + roots[i].root + "</option>"
				$("<option>")
					.html(roots[i].root)
			);
		} // fin remplissage du select des api 
		

		
		autologin();
	}); // fin doc.ready
	
	function chargerArticles(idA) {
	
		// idA doit être sélectionné dans le menu déroulant
		// (s'il est fourni) 
		
		// GET /articles 
		// $.getJSON(url, dataQS , fnCB) 
		
		$.getJSON(cache.apiRoot + "/articles", 
			{hash:cache.hash}, 
			function(oRep){
				console.log(oRep);
				
				/*
				"version":1.3,
				"success":true,
				"status":200,
				"apiname":"paragraphes",
				"articles":[{"id":"3351","titre":"Nouveau"}, ...
				*/
				
				// vide le menu déroulant des articles 
				$("select", "#articles").empty(); 
				
				// rajouter la première option 
				// <option selected disabled>Choisir l'article à éditer</option>
				$("select", "#articles").append(
						$("<option>")
							.html("Choisir l'article &agrave; &eacute;diter")
							.attr("selected","selected")
							.attr("disabled","disabled")						
				); 
								
				// remplir le select des articles 
				var i; // locale !! 
				for(i=0;i<oRep.articles.length;i++) {
				
					// on crée l'option représentant cet article 
					// c'est le moment de vérifier si c'est CELUI-LA qu'il faut sélectionner 
					
					var jOp = $("<option>")
								.html(oRep.articles[i].titre)
								.data(oRep.articles[i]); 
								
					if ((idA != undefined) && (idA == oRep.articles[i].id)) 
						jOp.attr("selected","selected");
						
					$("select", "#articles").append(jOp); 
						
				}
				
				// afficher 
				$("#articles").show();
				
				// déclencher l'événement change ! 
				$("select","#articles").change(); 
		
		}); // fin success get /articles 
		
		// remplir le menu déroulant dans #articles 
		// Attention à bien écraser les données précédentes ! 
		// penser à le vide d'abord avant de le remplir 
		// afficher #articles 
	
	} 
	
	function chargerArticle(oArticle) {
		console.log("chargerArticle");
		// Affiche le fs "article"
		$("#article").show(); 
		// afficher le titre de cet article 
		// dans la légende 
		
		// on stocke les méta-données de l'article 
		// dans le fieldset article 
		// EN PLUS du menu déroulant 
		$("#article").data(oArticle);
		
		// retrouver le titre : 
		// le passer en paramètre ! 
		// regarder l'option sélectionnée dans #articles select 
		// faire une requete GET /articles/<id>
		$("legend","#article").html(oArticle.titre); 
		
		// Récupérer ses P. 
		// GET /articles/<id>/paragraphes
		
		$.getJSON(cache.apiRoot + "/articles/" + oArticle.id + "/paragraphes", 
			{hash:cache.hash}, 
			function(oRep){
				console.log(oRep);
				var i; 
				$("#contenu").empty();
				
				// ATTENTION : les paragraphes ne sont pas triés... 
				// Il faut les trier AVANT de les afficher 
				oRep.paragraphes.sort(function(a,b){return parseInt(a.ordre) - parseInt(b.ordre);});
				for(i=0;i<oRep.paragraphes.length;i++) {
					var jPClone = jPEditable
						.clone(true)
						.data(oRep.paragraphes[i])
						.html(oRep.paragraphes[i].contenu); 
						
				// Créer un composant "div span span"
				// dans lequel on insérera le clone 
				// A MODIFIER : suppression du P avec son parent 
				// Ajouter : penser à insérer la même structure  
				// Penser à rendre facilement accessible les méta-données 
				var jCloneCP = jComposantP.clone(true);
				jCloneCP.append(jPClone);
					$("#contenu").append(jCloneCP);
				}		
			
		}); 
		
		// Les afficher 
		// Les manipuler 
	}
	
var jComposantP = $("<div>")
	.append($("<span>")
					.addClass("corbeille")
					.addClass("ui-icon")
					.addClass("ui-icon-trash"))
	.append($("<span>")
					.addClass("poignee")
					.addClass("ui-icon")
					.addClass("ui-icon-caret-2-n-s")); 
	
var jPEditable = $("<p>")
	.html("nouveau")
	.click(function(){
	
		// interdire l'édition des P. désactives
		if ($(this).hasClass("desactive"))
			return;
	
		// récupérer contenu actuel du P. => .html()
		var contenu=$(this).html(); 
		// créer un TA avec le même contenu => composant !
		var jTAClone = jTAValidable
			.clone(true)
			.val(contenu)
			.data($(this).data()); 
			 
		// remplacer le P. par ce TA => .replaceWith()
		$(this).replaceWith(jTAClone); 
		jTAClone.select();

	}); // fin jPEditable
	
var jTAValidable = $("<textarea>")
	.keydown(function(contexte){
		// SI (ENTREE vient d'être appuyée)
		if (contexte.key == "Enter") {
			// récupérer le contenu actuel du TA
			var contenu = $(this).val();
			var meta =  $(this).data();
			// Créer un P éditable avec ce même contenu  
			var jPClone = jPEditable
				.clone(true)
				.addClass("desactive")
				.data(meta)
				.html(contenu); 
				
	
				
			// var idArticle = $("#article").data("id"); 
			// var idArticle = $(this).parent().parent().data("id"); 
			var idArticle = $(this).parents("fieldset").data("id");

				
			// remplacer le TA par ce P
			$(this).replaceWith(jPClone);
			
			// envoyer une requete de mise à jour 
			// au serveur 
			// PUT /articles/id/paragraphes/id
			// + hash 
			// + contenu 
			
			$.ajax({
				type: "PUT",
				url: cache.apiRoot 
						+ "/articles/" + idArticle 
						+ "/paragraphes/" + meta.id
						+ "?contenu=" + contenu,		
				headers: {"hash":cache.hash},
				success: function(oRep){
					// TODO : mettre à jour le P. 
					// concerné par la requete AJAX PUT
					// où est-il ??? 
					// jPClone est justement enfermé dans le scope de la fonction !! 
						jPClone.data("contenu",oRep.paragraphe.contenu);
						jPClone.html(oRep.paragraphe.contenu);
						jPClone.removeClass("desactive");
				},
				dataType: "json"
			});
			
			// Lorsque le serveur aura validé 
			// la mise à jour 
			// on enlèvera la classe "desactive"
			
		}
	}); // fin jTAValidable 


var jAddDelA = 
	$("<div>")
		.addClass("m5")
		.append( // btn + 
			$("<input type='button'>")
				.val("+")
				.click(function(){
					var contenu = $("#articles input[type='text']").val();
					if (contenu=="") contenu = "Nouvel article"; 
						
					var jOp = $("<option>")
								.html(contenu + " *")
								.attr("disabled","disabled"); 
	
					// ajouter l'article au menu select 
					$("select", "#articles").append(jOp);
					
					// cacher les paragraphes 
					$("#article").hide(); 
					// effacer le champ 
					$(this).next().val("");
					
					
					// créer l'article sur l'API
					$.ajax({
						type: "POST",
						url: cache.apiRoot + "/articles",
						headers: {"hash":cache.hash},
						data: {"titre":contenu},
						dataType: "json", // nature du résultat attendu
						success: function(oRep){
							console.log(oRep);
							// réintégrer ses méta-données dans l'option 
							// sélectionner cet article 
							jOp
								.data(oRep.article)
								.html(oRep.article.titre)
								.removeAttr("disabled")								
								.prop("selected",true); 
							$("#articles select").change(); 
							// ce qui va charger ses paragraphes
						}
					}); // fin $.ajax 
					 
				
					
					
				})
		)
		.append(
			$("<input type='text'>")
		)
		.append( // btn + 
			$("<input type='button'>")
				.val("Supprimer")
				.click(function(){
				
				if ($.isEmptyObject($("#articles option:selected").data())) return; 
				// supprimer l'article sélectionné sur l'API
				$.ajax({
					type: "DELETE",
					url: cache.apiRoot + "/articles/" 
						+ $("#article").data("id"), 
						// NB : on pourrait aller chercher l'info dans le select 
					headers: {"hash":cache.hash},
					dataType: "json", // nature du résultat attendu
					success: function(oRep){
						console.log(oRep);
					}
				}); // fin $.ajax 
			
				// supprimer l'option, sélectionner la première  
				$("#articles option:selected").remove(); 	
				$("#articles option:first").prop("selected",true);
				
				// cacher les P. 
				$("#article").hide();
				})
		); 


var jAjoutP = 
	$("<div>")
		.addClass("m5")
		.append( // btn + 
			$("<input type='button'>")
				.val("+")
				.click(function(){
					var isFirst = $("#article input[value='+']:first").is($(this));
					var contenu = $(this).next().val(); 
					var jCloneP = jPEditable
						.clone(true)
						.addClass("desactive");
						
					if (contenu != "") jCloneP.html(contenu); 
					// if (contenu == "") contenu = "nouveau";
					
					var jCloneCP = jComposantP.clone(true);
					jCloneCP.append(jCloneP);
					var ordre = 0; 
					// ATTENTION : il faudrait que ce P. dispose du bon numéro d'ordre !! 
					
					if (isFirst) {
						
						// ordre ? valeur du premier -1 , sinon 0
						var premier = $("#contenu > *").first();
						console.log($("p,textarea",premier).data()); 
						if (premier.length !=0) ordre = $("p,textarea",premier).data("ordre")-1;  
						$("#contenu").prepend(jCloneCP);  
					} else {
						 
						// ordre ? valeur du dernier +1, sinon 0
						var dernier = $("#contenu > *").last();
						if (dernier.length !=0) ordre = $("p,textarea",dernier).data("ordre")+1;
						$("#contenu").append(jCloneCP);
					}

					var meta = $(this).parents("fieldset").data(); 
					$.ajax({
						type: "POST",
						url: cache.apiRoot + "/articles/" 
							+ meta.id
							+ "/paragraphes",
						headers: {"hash":cache.hash},
						data: {"contenu":jCloneP.html() },
						dataType: "json", // nature du résultat attendu
						success: function(oRep){
							console.log(oRep);
							
							
							// Il faut mettre à jour le numéro d'ordre ! 
							
							$.ajax({
								type: "PUT",
								url: cache.apiRoot 
										+ "/articles/" + meta.id 
										+ "/paragraphes/" + oRep.paragraphe.id
										+ "?ordre=" + ordre,		
								headers: {"hash":cache.hash},
								success: function(oRep){
									// on réinsère les méta du P. côté serveur
									// oRep.paragraphe
									// dans le P. côté client 
									
									jCloneP
										.data(oRep.paragraphe)
										.html(oRep.paragraphe.contenu)
										.removeClass("desactive");
								},
								dataType: "json"
							});

							
						}
					}); // fin $.ajax 
				
				}) // fin fn click btn + 
		) // fin append btn+
		.append( // champ texte 
			$("<input type='text'>")
		); 
		// fin composant ajoutP
</script>

<body>

	<fieldset id="serveur">
		<legend>Serveur</legend>
		<select>
			<option selected disabled>Choisir la racine de l'API</option>
		</select>
		<div class="hidden" id="pseudo"></div>
		<input class="hidden" type="button" value="Logout"/>
	</fieldset>
	
	<fieldset class="hidden" id="identification">
		<legend>Identification</legend>
		Pseudo : <input type="text" value="tom"/> <br />
		Password : <input type="password" value="web" /> <br />
		<input type="button" value="OK"/>
		<div class="hidden red" id="msg"></div>
	</fieldset>
	
	<fieldset class="hidden" id="articles">
		<legend>Articles</legend>
		<select>
			<option selected disabled>Choisir l'article à éditer</option>
		</select>
		<div class="hidden red"></div>
	</fieldset>
	
	<fieldset class="hidden" id="article">
		<legend>Article</legend>
		<div id="contenu"></div>
	</fieldset>
	
</body>

	

